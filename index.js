(()=>{"use strict";var t={104:(t,e,n)=>{t.exports=n.p+"3f1f54282fe191bf3e67.wasm"}},e={};function n(o){var r=e[o];if(void 0!==r)return r.exports;var i=e[o]={exports:{}};return t[o](i,i.exports,n),i.exports}let o;n.m=t,n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),n.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),(()=>{var t;n.g.importScripts&&(t=n.g.location+"");var e=n.g.document;if(!t&&e&&(e.currentScript&&"SCRIPT"===e.currentScript.tagName.toUpperCase()&&(t=e.currentScript.src),!t)){var o=e.getElementsByTagName("script");if(o.length)for(var r=o.length-1;r>-1&&(!t||!/^http(s?):/.test(t));)t=o[r--].src}if(!t)throw new Error("Automatic publicPath is not supported in this browser");t=t.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),n.p=t})(),n.b=document.baseURI||self.location.href;const r=new Array(128).fill(void 0);function i(t){return r[t]}r.push(void 0,null,!0,!1);let s=r.length;function c(t){s===r.length&&r.push(r.length+1);const e=s;return s=r[e],r[e]=t,e}function a(t,e){try{return t.apply(this,e)}catch(t){o.__wbindgen_exn_store(c(t))}}function u(t){const e=i(t);return function(t){t<132||(r[t]=s,s=t)}(t),e}function l(t){return null==t}let b=null;function _(){return(null===b||!0===b.buffer.detached||void 0===b.buffer.detached&&b.buffer!==o.memory.buffer)&&(b=new DataView(o.memory.buffer)),b}function g(t){const e=typeof t;if("number"==e||"boolean"==e||null==t)return`${t}`;if("string"==e)return`"${t}"`;if("symbol"==e){const e=t.description;return null==e?"Symbol":`Symbol(${e})`}if("function"==e){const e=t.name;return"string"==typeof e&&e.length>0?`Function(${e})`:"Function"}if(Array.isArray(t)){const e=t.length;let n="[";e>0&&(n+=g(t[0]));for(let o=1;o<e;o++)n+=", "+g(t[o]);return n+="]",n}const n=/\[object ([^\]]+)\]/.exec(toString.call(t));let o;if(!(n&&n.length>1))return toString.call(t);if(o=n[1],"Object"==o)try{return"Object("+JSON.stringify(t)+")"}catch(t){return"Object"}return t instanceof Error?`${t.name}: ${t.message}\n${t.stack}`:o}let d=0,f=null;function h(){return null!==f&&0!==f.byteLength||(f=new Uint8Array(o.memory.buffer)),f}const p="undefined"!=typeof TextEncoder?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},w="function"==typeof p.encodeInto?function(t,e){return p.encodeInto(t,e)}:function(t,e){const n=p.encode(t);return e.set(n),{read:t.length,written:n.length}};function m(t,e,n){if(void 0===n){const n=p.encode(t),o=e(n.length,1)>>>0;return h().subarray(o,o+n.length).set(n),d=n.length,o}let o=t.length,r=e(o,1)>>>0;const i=h();let s=0;for(;s<o;s++){const e=t.charCodeAt(s);if(e>127)break;i[r+s]=e}if(s!==o){0!==s&&(t=t.slice(s)),r=n(r,o,o=s+3*t.length,1)>>>0;const e=h().subarray(r+s,r+o);s+=w(t,e).written,r=n(r,o,s,1)>>>0}return d=s,r}const y="undefined"!=typeof TextDecoder?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};function v(t,e){return t>>>=0,y.decode(h().subarray(t,t+e))}"undefined"!=typeof TextDecoder&&y.decode();const x="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((t=>o.__wbg_game_free(t>>>0,1)));class j{__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,x.unregister(this),t}free(){const t=this.__destroy_into_raw();o.__wbg_game_free(t,0)}constructor(){const t=o.game_new();return this.__wbg_ptr=t>>>0,x.register(this,this.__wbg_ptr,this),this}get board(){return u(o.game_board(this.__wbg_ptr))}get player_position(){return u(o.game_player_position(this.__wbg_ptr))}get is_complete(){return u(o.game_is_complete(this.__wbg_ptr))}get move_count(){return u(o.game_move_count(this.__wbg_ptr))}get objects_positions(){return u(o.game_objects_positions(this.__wbg_ptr))}update_player_position(t){return 0!==o.game_update_player_position(this.__wbg_ptr,c(t))}}function $(){const t={wbg:{}};return t.wbg.__wbg_buffer_609cc3eee51ed158=function(t){return c(i(t).buffer)},t.wbg.__wbg_call_672a4d21634d4a24=function(){return a((function(t,e){return c(i(t).call(i(e)))}),arguments)},t.wbg.__wbg_done_769e5ede4b31c67b=function(t){return i(t).done},t.wbg.__wbg_get_67b2ba62fc30de12=function(){return a((function(t,e){return c(Reflect.get(i(t),i(e)))}),arguments)},t.wbg.__wbg_get_b9b93047fe3cf45b=function(t,e){return c(i(t)[e>>>0])},t.wbg.__wbg_instanceof_ArrayBuffer_e14585432e3737fc=function(t){let e;try{e=i(t)instanceof ArrayBuffer}catch(t){e=!1}return e},t.wbg.__wbg_instanceof_Uint8Array_17156bcf118086a9=function(t){let e;try{e=i(t)instanceof Uint8Array}catch(t){e=!1}return e},t.wbg.__wbg_isArray_a1eab7e0d067391b=function(t){return Array.isArray(i(t))},t.wbg.__wbg_isSafeInteger_343e2beeeece1bb0=function(t){return Number.isSafeInteger(i(t))},t.wbg.__wbg_iterator_9a24c88df860dc65=function(){return c(Symbol.iterator)},t.wbg.__wbg_length_a446193dc22c12f8=function(t){return i(t).length},t.wbg.__wbg_length_e2d2a49132c1b256=function(t){return i(t).length},t.wbg.__wbg_new_78feb108b6472713=function(){return c(new Array)},t.wbg.__wbg_new_a12002a7f91c75be=function(t){return c(new Uint8Array(i(t)))},t.wbg.__wbg_next_25feadfc0913fea9=function(t){return c(i(t).next)},t.wbg.__wbg_next_6574e1a8a62d1055=function(){return a((function(t){return c(i(t).next())}),arguments)},t.wbg.__wbg_set_37837023f3d740e8=function(t,e,n){i(t)[e>>>0]=u(n)},t.wbg.__wbg_set_65595bdd868b3009=function(t,e,n){i(t).set(i(e),n>>>0)},t.wbg.__wbg_value_cd1ffa7b1ab794f1=function(t){return c(i(t).value)},t.wbg.__wbindgen_bigint_from_i64=function(t){return c(t)},t.wbg.__wbindgen_bigint_from_u64=function(t){return c(BigInt.asUintN(64,t))},t.wbg.__wbindgen_bigint_get_as_i64=function(t,e){const n=i(e),o="bigint"==typeof n?n:void 0;_().setBigInt64(t+8,l(o)?BigInt(0):o,!0),_().setInt32(t+0,!l(o),!0)},t.wbg.__wbindgen_boolean_get=function(t){const e=i(t);return"boolean"==typeof e?e?1:0:2},t.wbg.__wbindgen_debug_string=function(t,e){const n=m(g(i(e)),o.__wbindgen_malloc,o.__wbindgen_realloc),r=d;_().setInt32(t+4,r,!0),_().setInt32(t+0,n,!0)},t.wbg.__wbindgen_error_new=function(t,e){return c(new Error(v(t,e)))},t.wbg.__wbindgen_is_bigint=function(t){return"bigint"==typeof i(t)},t.wbg.__wbindgen_is_function=function(t){return"function"==typeof i(t)},t.wbg.__wbindgen_is_object=function(t){const e=i(t);return"object"==typeof e&&null!==e},t.wbg.__wbindgen_jsval_eq=function(t,e){return i(t)===i(e)},t.wbg.__wbindgen_jsval_loose_eq=function(t,e){return i(t)==i(e)},t.wbg.__wbindgen_memory=function(){return c(o.memory)},t.wbg.__wbindgen_number_get=function(t,e){const n=i(e),o="number"==typeof n?n:void 0;_().setFloat64(t+8,l(o)?0:o,!0),_().setInt32(t+0,!l(o),!0)},t.wbg.__wbindgen_number_new=function(t){return c(t)},t.wbg.__wbindgen_object_drop_ref=function(t){u(t)},t.wbg.__wbindgen_string_get=function(t,e){const n=i(e),r="string"==typeof n?n:void 0;var s=l(r)?0:m(r,o.__wbindgen_malloc,o.__wbindgen_realloc),c=d;_().setInt32(t+4,c,!0),_().setInt32(t+0,s,!0)},t.wbg.__wbindgen_throw=function(t,e){throw new Error(v(t,e))},t}async function k(t){if(void 0!==o)return o;void 0!==t&&(Object.getPrototypeOf(t)===Object.prototype?({module_or_path:t}=t):console.warn("using deprecated parameters for the initialization function; pass a single object instead")),void 0===t&&(t=new URL(n(104),n.b));const e=$();("string"==typeof t||"function"==typeof Request&&t instanceof Request||"function"==typeof URL&&t instanceof URL)&&(t=fetch(t));const{instance:r,module:i}=await async function(t,e){if("function"==typeof Response&&t instanceof Response){if("function"==typeof WebAssembly.instantiateStreaming)try{return await WebAssembly.instantiateStreaming(t,e)}catch(e){if("application/wasm"==t.headers.get("Content-Type"))throw e;console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",e)}const n=await t.arrayBuffer();return await WebAssembly.instantiate(n,e)}{const n=await WebAssembly.instantiate(t,e);return n instanceof WebAssembly.Instance?{instance:n,module:t}:n}}(await t,e);return function(t,e){return o=t.exports,k.__wbindgen_wasm_module=e,b=null,f=null,o}(r,i)}const A=k;class T{constructor(t,e){this.$debug=null,this.$container=document.querySelector(`#${t}`),this.title=e}render(){this.$container.innerHTML=`\n  <h1>${this.title}</h1>\n\n  <canvas id="scene"></canvas>\n\n  <p>\n    <pre id="debug"></pre>\n  </p>\n    `,this.$debug=this.$container.querySelector("#debug")}debug(t){this.$debug&&(this.$debug.innerText=t)}}const S=class{constructor(t){this.loopId=0,this.startTimestamp=0,this.timestamp=0,this.framesCount=0,this.renderer=t}start(t){this.startTimestamp=Number((Date.now()/1e3).toFixed()),this.timestamp=this.startTimestamp,requestAnimationFrame((()=>this.loop(t)))}stop(){cancelAnimationFrame(this.loopId),this.timestamp=0,this.loopId=0}loop(t){if(0<this.loopId){t(),this.renderer.render(),this.framesCount++;let e=Number((Date.now()/1e3).toFixed());this.timestamp<e&&(console.log(`time: ${this.timestamp-this.startTimestamp}\nframesCount: ${this.framesCount}`),this.timestamp=e,this.framesCount=0)}this.loopId=requestAnimationFrame((()=>this.loop(t)))}};var I;!function(t){t[t.Lines=0]="Lines",t[t.Filled=1]="Filled"}(I||(I={}));const O=class{constructor(t,e){this.objects={},this.$canvas=t,this.context=this.$canvas.getContext("2d"),this.options=e,this.setCanvas(),this.clear()}render(){this.clear(),this.renderScene(),this.renderObjects()}add(t){return t.id in this.objects?(console.error(`object ${t.id} already added`),!1):(this.objects[t.id]=t,!0)}remove(t){return t in this.objects?(delete this.objects[t],!0):(console.error(`object ${t} not added`),!1)}setCanvas(){const{width:t,height:e,backgroundColor:n}=this.options;this.$canvas.width=t,this.$canvas.height=e,this.$canvas.style.backgroundColor=this.rgba(n)}clear(){const{width:t,height:e}=this.options;this.context.clearRect(0,0,t,e)}rgba(t){return`rgba(${t.join(", ")})`}renderScene(){const{width:t,height:e,resolution:n}=this.options,o=[t/n[0],e/n[1]];this.context.strokeStyle=this.rgba([0,0,0,1]),this.context.lineWidth=.1,this.context.beginPath(),[...Array(o[1]-1).keys()].map((r=>{this.context.moveTo(0,(r+1)*n[1]),this.context.lineTo(t,(r+1)*n[1]),[...Array(o[0]-1).keys()].map((t=>{this.context.moveTo((t+1)*n[0],0),this.context.lineTo((t+1)*n[0],e)}))})),this.context.stroke()}renderObjects(){const{resolution:t}=this.options;Object.keys(this.objects).map((e=>{const n=this.objects[e],{position:o,data:r,color:i,scale:s,type:c,rotation:a}=n,u=I.Lines===c;let l=[0,0];if(this.context[u?"strokeStyle":"fillStyle"]=this.rgba(i),this.context.beginPath(),this.rotate(r,a).map(((e,n)=>{const r=[o[0]*t[0]+e[0]*s[0]*t[0],o[1]*t[1]+e[1]*s[1]*t[1]];this.context[0===n?"moveTo":"lineTo"](r[0],r[1]),l[0]<r[0]&&(l[0]=r[0]),l[1]<r[1]&&(l[1]=r[1])})),this.context[u?"stroke":"fill"](),n.texture){let e=[o[0]*t[0],o[1]*t[1]];this.context.drawImage(n.texture,e[0],e[1],l[0]-e[0],l[1]-e[1])}}))}rotate(t,e){return t}},E=class{constructor(t){this.eventObjects=[],this.$eventListener=document.createElement("div"),this.eventObjects=t,this.eventObjects.map((t=>{const{name:e,eventType:n,$target:o,dataCallback:r}=t;o.addEventListener(n,(t=>{this.$eventListener.dispatchEvent(new CustomEvent(e,{detail:r(o,t)}))}))}))}addEventListener(t,e){this.$eventListener.addEventListener(t,(t=>e(t.detail)))}};var C=function(t,e,n,o){return new(n||(n=Promise))((function(r,i){function s(t){try{a(o.next(t))}catch(t){i(t)}}function c(t){try{a(o.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,c)}a((o=o.apply(t,e||[])).next())}))};window.addEventListener("load",(()=>{A().then((()=>C(void 0,void 0,void 0,(function*(){const t=new T("app","Sokoban");t.render();const e=new j,n=yield function(t){return C(this,void 0,void 0,(function*(){return yield Promise.all(t.map((t=>new Promise((e=>{const n=new Image;n.src=t,n.addEventListener("load",(()=>(console.log(`${n.src} loaded`),e(n))))})))))}))}(["./assets/block.png","./assets/box.png","./assets/player.png"]);console.log(n),console.log("ok");const o=(()=>{const t=e.board.length;return{width:500,height:500,backgroundColor:[255,255,255,1],resolution:[500/e.board[0].length,500/t]}})(),r={id:"player",position:e.player_position,data:[[0,0,0],[0,1,0],[1,1,0],[1,0,0]],color:[100,100,255,1],texture:yield n[2],scale:[1,1],rotation:[0,0,0],type:I.Filled},[i,s,c]=e.objects_positions.map(((t,e)=>t.map(((t,o)=>{const r={position:t,data:[[0,0,0],[0,1,0],[1,1,0],[1,0,0]],scale:[1,1],rotation:[0,0,0],type:I.Filled};switch(e){case 0:return Object.assign({id:`block-${o}`,color:[125,125,125,1],texture:n[0]},r);case 1:return Object.assign({id:`target-${o}`,color:[250,250,200,1]},r);case 2:return Object.assign({id:`box-${o}`,color:[200,150,0,1],texture:n[1]},r)}})))),a=c.map(((t,e)=>Object.assign(Object.assign({},t),{id:`box-line-${e}`,data:[[0,0,0],[1,1,0],[0,1,0],[1,0,0]],color:[0,0,0,1],type:I.Lines}))),u=[{name:"test-click",eventType:"click",$target:t.$container.querySelector("#scene"),dataCallback:(t,e)=>{const n=t.getBoundingClientRect();return{position:[e.clientX-n.left,e.clientY-n.top]}}},{name:"go-to",eventType:"keyup",$target:document,dataCallback:(t,e)=>{let n=null;switch(e.key){case"ArrowUp":n="up";break;case"ArrowDown":n="down";break;case"ArrowLeft":n="left";break;case"ArrowRight":n="right"}return{direction:n}}}],l=new O(t.$container.querySelector("#scene"),o),b=new E(u),_=new S(l);[r,...i,...s,...c,...a].map((t=>l.add(t))),b.addEventListener(u[0].name,(t=>{t.position&&console.log("click:",t.position)})),b.addEventListener(u[1].name,(t=>{if(!t.direction)return;let n=[0,0];switch(t.direction){case"up":n[1]=-1;break;case"down":n[1]=1;break;case"left":n[0]=-1;break;case"right":n[0]=1}0===n[0]&&0===n[1]||(e.update_player_position(n)?(r.position=e.player_position,[...Array(e.objects_positions[2].length).keys()].map((t=>{c[t].position=e.objects_positions[2][t],a[t].position=e.objects_positions[2][t]})),e.is_complete&&setTimeout((()=>{_.stop(),alert("Finished!")}),100)):console.error(`unable to update player position with offset [${n.join(", ")}]`))})),_.start((()=>{t.debug(`move count: ${e.move_count}\n\n`+e.board.reduce(((t,e)=>t+e.join(" ")+"\n"),""))}))}))))}))})();