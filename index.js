(()=>{"use strict";var t={104:(t,e,n)=>{t.exports=n.p+"3f1f54282fe191bf3e67.wasm"}},e={};function n(r){var o=e[r];if(void 0!==o)return o.exports;var i=e[r]={exports:{}};return t[r](i,i.exports,n),i.exports}let r;n.m=t,n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),n.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),(()=>{var t;n.g.importScripts&&(t=n.g.location+"");var e=n.g.document;if(!t&&e&&(e.currentScript&&"SCRIPT"===e.currentScript.tagName.toUpperCase()&&(t=e.currentScript.src),!t)){var r=e.getElementsByTagName("script");if(r.length)for(var o=r.length-1;o>-1&&(!t||!/^http(s?):/.test(t));)t=r[o--].src}if(!t)throw new Error("Automatic publicPath is not supported in this browser");t=t.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),n.p=t})(),n.b=document.baseURI||self.location.href;const o=new Array(128).fill(void 0);function i(t){return o[t]}o.push(void 0,null,!0,!1);let s=o.length;function a(t){s===o.length&&o.push(o.length+1);const e=s;return s=o[e],o[e]=t,e}function c(t,e){try{return t.apply(this,e)}catch(t){r.__wbindgen_exn_store(a(t))}}function u(t){const e=i(t);return function(t){t<132||(o[t]=s,s=t)}(t),e}function l(t){return null==t}let b=null;function d(){return(null===b||!0===b.buffer.detached||void 0===b.buffer.detached&&b.buffer!==r.memory.buffer)&&(b=new DataView(r.memory.buffer)),b}function _(t){const e=typeof t;if("number"==e||"boolean"==e||null==t)return`${t}`;if("string"==e)return`"${t}"`;if("symbol"==e){const e=t.description;return null==e?"Symbol":`Symbol(${e})`}if("function"==e){const e=t.name;return"string"==typeof e&&e.length>0?`Function(${e})`:"Function"}if(Array.isArray(t)){const e=t.length;let n="[";e>0&&(n+=_(t[0]));for(let r=1;r<e;r++)n+=", "+_(t[r]);return n+="]",n}const n=/\[object ([^\]]+)\]/.exec(toString.call(t));let r;if(!(n&&n.length>1))return toString.call(t);if(r=n[1],"Object"==r)try{return"Object("+JSON.stringify(t)+")"}catch(t){return"Object"}return t instanceof Error?`${t.name}: ${t.message}\n${t.stack}`:r}let g=0,f=null;function h(){return null!==f&&0!==f.byteLength||(f=new Uint8Array(r.memory.buffer)),f}const p="undefined"!=typeof TextEncoder?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},w="function"==typeof p.encodeInto?function(t,e){return p.encodeInto(t,e)}:function(t,e){const n=p.encode(t);return e.set(n),{read:t.length,written:n.length}};function m(t,e,n){if(void 0===n){const n=p.encode(t),r=e(n.length,1)>>>0;return h().subarray(r,r+n.length).set(n),g=n.length,r}let r=t.length,o=e(r,1)>>>0;const i=h();let s=0;for(;s<r;s++){const e=t.charCodeAt(s);if(e>127)break;i[o+s]=e}if(s!==r){0!==s&&(t=t.slice(s)),o=n(o,r,r=s+3*t.length,1)>>>0;const e=h().subarray(o+s,o+r);s+=w(t,e).written,o=n(o,r,s,1)>>>0}return g=s,o}const y="undefined"!=typeof TextDecoder?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};function v(t,e){return t>>>=0,y.decode(h().subarray(t,t+e))}"undefined"!=typeof TextDecoder&&y.decode();const j="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((t=>r.__wbg_game_free(t>>>0,1)));class ${__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,j.unregister(this),t}free(){const t=this.__destroy_into_raw();r.__wbg_game_free(t,0)}constructor(){const t=r.game_new();return this.__wbg_ptr=t>>>0,j.register(this,this.__wbg_ptr,this),this}get board(){return u(r.game_board(this.__wbg_ptr))}get player_position(){return u(r.game_player_position(this.__wbg_ptr))}get is_complete(){return u(r.game_is_complete(this.__wbg_ptr))}get move_count(){return u(r.game_move_count(this.__wbg_ptr))}get objects_positions(){return u(r.game_objects_positions(this.__wbg_ptr))}update_player_position(t){return 0!==r.game_update_player_position(this.__wbg_ptr,a(t))}}function x(){const t={wbg:{}};return t.wbg.__wbg_buffer_609cc3eee51ed158=function(t){return a(i(t).buffer)},t.wbg.__wbg_call_672a4d21634d4a24=function(){return c((function(t,e){return a(i(t).call(i(e)))}),arguments)},t.wbg.__wbg_done_769e5ede4b31c67b=function(t){return i(t).done},t.wbg.__wbg_get_67b2ba62fc30de12=function(){return c((function(t,e){return a(Reflect.get(i(t),i(e)))}),arguments)},t.wbg.__wbg_get_b9b93047fe3cf45b=function(t,e){return a(i(t)[e>>>0])},t.wbg.__wbg_instanceof_ArrayBuffer_e14585432e3737fc=function(t){let e;try{e=i(t)instanceof ArrayBuffer}catch(t){e=!1}return e},t.wbg.__wbg_instanceof_Uint8Array_17156bcf118086a9=function(t){let e;try{e=i(t)instanceof Uint8Array}catch(t){e=!1}return e},t.wbg.__wbg_isArray_a1eab7e0d067391b=function(t){return Array.isArray(i(t))},t.wbg.__wbg_isSafeInteger_343e2beeeece1bb0=function(t){return Number.isSafeInteger(i(t))},t.wbg.__wbg_iterator_9a24c88df860dc65=function(){return a(Symbol.iterator)},t.wbg.__wbg_length_a446193dc22c12f8=function(t){return i(t).length},t.wbg.__wbg_length_e2d2a49132c1b256=function(t){return i(t).length},t.wbg.__wbg_new_78feb108b6472713=function(){return a(new Array)},t.wbg.__wbg_new_a12002a7f91c75be=function(t){return a(new Uint8Array(i(t)))},t.wbg.__wbg_next_25feadfc0913fea9=function(t){return a(i(t).next)},t.wbg.__wbg_next_6574e1a8a62d1055=function(){return c((function(t){return a(i(t).next())}),arguments)},t.wbg.__wbg_set_37837023f3d740e8=function(t,e,n){i(t)[e>>>0]=u(n)},t.wbg.__wbg_set_65595bdd868b3009=function(t,e,n){i(t).set(i(e),n>>>0)},t.wbg.__wbg_value_cd1ffa7b1ab794f1=function(t){return a(i(t).value)},t.wbg.__wbindgen_bigint_from_i64=function(t){return a(t)},t.wbg.__wbindgen_bigint_from_u64=function(t){return a(BigInt.asUintN(64,t))},t.wbg.__wbindgen_bigint_get_as_i64=function(t,e){const n=i(e),r="bigint"==typeof n?n:void 0;d().setBigInt64(t+8,l(r)?BigInt(0):r,!0),d().setInt32(t+0,!l(r),!0)},t.wbg.__wbindgen_boolean_get=function(t){const e=i(t);return"boolean"==typeof e?e?1:0:2},t.wbg.__wbindgen_debug_string=function(t,e){const n=m(_(i(e)),r.__wbindgen_malloc,r.__wbindgen_realloc),o=g;d().setInt32(t+4,o,!0),d().setInt32(t+0,n,!0)},t.wbg.__wbindgen_error_new=function(t,e){return a(new Error(v(t,e)))},t.wbg.__wbindgen_is_bigint=function(t){return"bigint"==typeof i(t)},t.wbg.__wbindgen_is_function=function(t){return"function"==typeof i(t)},t.wbg.__wbindgen_is_object=function(t){const e=i(t);return"object"==typeof e&&null!==e},t.wbg.__wbindgen_jsval_eq=function(t,e){return i(t)===i(e)},t.wbg.__wbindgen_jsval_loose_eq=function(t,e){return i(t)==i(e)},t.wbg.__wbindgen_memory=function(){return a(r.memory)},t.wbg.__wbindgen_number_get=function(t,e){const n=i(e),r="number"==typeof n?n:void 0;d().setFloat64(t+8,l(r)?0:r,!0),d().setInt32(t+0,!l(r),!0)},t.wbg.__wbindgen_number_new=function(t){return a(t)},t.wbg.__wbindgen_object_drop_ref=function(t){u(t)},t.wbg.__wbindgen_string_get=function(t,e){const n=i(e),o="string"==typeof n?n:void 0;var s=l(o)?0:m(o,r.__wbindgen_malloc,r.__wbindgen_realloc),a=g;d().setInt32(t+4,a,!0),d().setInt32(t+0,s,!0)},t.wbg.__wbindgen_throw=function(t,e){throw new Error(v(t,e))},t}async function k(t){if(void 0!==r)return r;void 0!==t&&(Object.getPrototypeOf(t)===Object.prototype?({module_or_path:t}=t):console.warn("using deprecated parameters for the initialization function; pass a single object instead")),void 0===t&&(t=new URL(n(104),n.b));const e=x();("string"==typeof t||"function"==typeof Request&&t instanceof Request||"function"==typeof URL&&t instanceof URL)&&(t=fetch(t));const{instance:o,module:i}=await async function(t,e){if("function"==typeof Response&&t instanceof Response){if("function"==typeof WebAssembly.instantiateStreaming)try{return await WebAssembly.instantiateStreaming(t,e)}catch(e){if("application/wasm"==t.headers.get("Content-Type"))throw e;console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",e)}const n=await t.arrayBuffer();return await WebAssembly.instantiate(n,e)}{const n=await WebAssembly.instantiate(t,e);return n instanceof WebAssembly.Instance?{instance:n,module:t}:n}}(await t,e);return function(t,e){return r=t.exports,k.__wbindgen_wasm_module=e,b=null,f=null,r}(o,i)}const A=k;class T{constructor(t,e){this.$debug=null,this.$container=document.querySelector(`#${t}`),this.title=e}render(){this.$container.innerHTML=`\n  <h1>${this.title}</h1>\n\n  <canvas id="scene"></canvas>\n\n  <p>\n    <pre id="debug"></pre>\n  </p>\n    `,this.$debug=this.$container.querySelector("#debug")}debug(t){this.$debug&&(this.$debug.innerText=t)}}const C=class{constructor(t){this.loopId=0,this.startTimestamp=0,this.timestamp=0,this.framesCount=0,this.renderer=t}start(t){this.startTimestamp=Number((Date.now()/1e3).toFixed()),this.timestamp=this.startTimestamp,requestAnimationFrame((()=>this.loop(t)))}stop(){cancelAnimationFrame(this.loopId),this.timestamp=0,this.loopId=0}loop(t){if(0<this.loopId){t(),this.renderer.render(),this.framesCount++;let e=Number((Date.now()/1e3).toFixed());this.timestamp<e&&(console.log(`time: ${this.timestamp-this.startTimestamp}\nframesCount: ${this.framesCount}`),this.timestamp=e,this.framesCount=0)}this.loopId=requestAnimationFrame((()=>this.loop(t)))}};var I;!function(t){t[t.Lines=0]="Lines",t[t.Filled=1]="Filled"}(I||(I={}));const O=class{constructor(t,e,n){this.objects={},this.staticObjects={},this.background=null,this.$canvas=t,this.context=this.$canvas.getContext("2d"),this.$shadow=document.createElement("canvas"),this.shadowContext=this.$shadow.getContext("2d"),this.staticObjects=e,this.options=n,this.setCanvas(),this.setBackground(),this.clear()}render(){this.clear(),this.renderBackground(this.context),this.renderObjects(this.context,this.objects)}add(t){return t.id in this.objects?(console.error(`object ${t.id} already added`),!1):(this.objects[t.id]=t,!0)}remove(t){return t in this.objects?(delete this.objects[t],!0):(console.error(`object ${t} not added`),!1)}setCanvas(){const{width:t,height:e,backgroundColor:n}=this.options;[this.$canvas,this.$shadow].map((r=>{r.width=t,r.height=e,r.style.backgroundColor=this.rgba(n)}))}setBackground(){const{width:t,height:e}=this.options;this.shadowContext.clearRect(0,0,t,e),this.renderScene(this.shadowContext),this.renderObjects(this.shadowContext,this.staticObjects),this.background=this.shadowContext.getImageData(0,0,t,e)}clear(){const{width:t,height:e}=this.options;this.context.clearRect(0,0,t,e)}rgba(t){return`rgba(${t.join(", ")})`}renderScene(t){const{width:e,height:n,resolution:r}=this.options,o=[e/r[0],n/r[1]];t.strokeStyle=this.rgba([0,0,0,1]),t.lineWidth=.1,t.beginPath(),[...Array(o[1]-1).keys()].map((i=>{t.moveTo(0,(i+1)*r[1]),t.lineTo(e,(i+1)*r[1]),[...Array(o[0]-1).keys()].map((e=>{t.moveTo((e+1)*r[0],0),t.lineTo((e+1)*r[0],n)}))})),t.stroke()}renderBackground(t){this.background&&t.putImageData(this.background,0,0)}renderObjects(t,e){const{resolution:n}=this.options;Object.keys(e).map((r=>{const o=e[r],{position:i,data:s,color:a,scale:c,type:u,rotation:l}=o,b=I.Lines===u;let d=[0,0];if(t[b?"strokeStyle":"fillStyle"]=this.rgba(a),t.beginPath(),this.rotate(s,l).map(((e,r)=>{const o=[i[0]*n[0]+e[0]*c[0]*n[0],i[1]*n[1]+e[1]*c[1]*n[1]];t[0===r?"moveTo":"lineTo"](o[0],o[1]),d[0]<o[0]&&(d[0]=o[0]),d[1]<o[1]&&(d[1]=o[1])})),t[b?"stroke":"fill"](),o.texture){let e=[i[0]*n[0],i[1]*n[1]];t.drawImage(o.texture,e[0],e[1],d[0]-e[0],d[1]-e[1])}}))}rotate(t,e){return t}},S=class{constructor(t){this.eventObjects=[],this.$eventListener=document.createElement("div"),this.eventObjects=t,this.eventObjects.map((t=>{const{name:e,eventType:n,$target:r,dataCallback:o}=t;r.addEventListener(n,(t=>{this.$eventListener.dispatchEvent(new CustomEvent(e,{detail:o(r,t)}))}))}))}addEventListener(t,e){this.$eventListener.addEventListener(t,(t=>e(t.detail)))}};var E=function(t,e,n,r){return new(n||(n=Promise))((function(o,i){function s(t){try{c(r.next(t))}catch(t){i(t)}}function a(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((r=r.apply(t,e||[])).next())}))};window.addEventListener("load",(()=>{A().then((()=>E(void 0,void 0,void 0,(function*(){const t=new T("app","Sokoban");t.render();const e=new $,n=yield function(t){return E(this,void 0,void 0,(function*(){return yield Promise.all(t.map((t=>new Promise((e=>{const n=new Image;n.src=t,n.addEventListener("load",(()=>(console.log(`${n.src} loaded`),e(n))))})))))}))}(["./assets/block.png","./assets/box.png","./assets/player.png"]),r=(()=>{const t=e.board.length;return{width:500,height:500,backgroundColor:[255,255,255,1],resolution:[500/e.board[0].length,500/t]}})(),o={id:"player",position:e.player_position,data:[[0,0,0],[0,1,0],[1,1,0],[1,0,0]],color:[100,100,255,1],texture:yield n[2],scale:[1,1],rotation:[0,0,0],type:I.Filled},[i,s,a]=e.objects_positions.map(((t,e)=>t.map(((t,r)=>{const o={position:t,data:[[0,0,0],[0,1,0],[1,1,0],[1,0,0]],scale:[1,1],rotation:[0,0,0],type:I.Filled};switch(e){case 0:return Object.assign({id:`block-${r}`,color:[125,125,125,1],texture:n[0]},o);case 1:return Object.assign({id:`target-${r}`,color:[0,0,0,1]},o);case 2:return Object.assign({id:`box-${r}`,color:[200,150,0,1],texture:n[1]},o)}})))),c=a.map(((t,e)=>Object.assign(Object.assign({},t),{id:`box-line-${e}`,data:[[0,0,0],[1,1,0],[0,1,0],[1,0,0]],color:[0,0,0,1],type:I.Lines}))),u=[{name:"test-click",eventType:"click",$target:t.$container.querySelector("#scene"),dataCallback:(t,e)=>{const n=t.getBoundingClientRect();return{position:[e.clientX-n.left,e.clientY-n.top]}}},{name:"go-to",eventType:"keyup",$target:document,dataCallback:(t,e)=>{let n=null;switch(e.key){case"ArrowUp":n="up";break;case"ArrowDown":n="down";break;case"ArrowLeft":n="left";break;case"ArrowRight":n="right"}return{direction:n}}}],l=new O(t.$container.querySelector("#scene"),[...i,...s].reduce(((t,e)=>(t[e.id]=e,t)),{}),r),b=new S(u),d=new C(l);[o,...a,...c].map((t=>l.add(t))),b.addEventListener(u[0].name,(t=>{t.position&&console.log("click:",t.position)})),b.addEventListener(u[1].name,(t=>{if(!t.direction)return;let n=[0,0];switch(t.direction){case"up":n[1]=-1;break;case"down":n[1]=1;break;case"left":n[0]=-1;break;case"right":n[0]=1}0===n[0]&&0===n[1]||(e.update_player_position(n)?(o.position=e.player_position,[...Array(e.objects_positions[2].length).keys()].map((t=>{a[t].position=e.objects_positions[2][t],c[t].position=e.objects_positions[2][t]})),e.is_complete&&setTimeout((()=>{d.stop(),alert("Finished!")}),100)):console.error(`unable to update player position with offset [${n.join(", ")}]`))})),d.start((()=>{t.debug(`move count: ${e.move_count}\n\n`+e.board.reduce(((t,e)=>t+e.join(" ")+"\n"),""))}))}))))}))})();