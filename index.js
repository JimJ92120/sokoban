(()=>{"use strict";var e={104:(e,t,n)=>{e.exports=n.p+"b7541624b1338ae06875.wasm"}},t={};function n(r){var o=t[r];if(void 0!==o)return o.exports;var i=t[r]={exports:{}};return e[r](i,i.exports,n),i.exports}let r;n.m=e,n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var e;n.g.importScripts&&(e=n.g.location+"");var t=n.g.document;if(!e&&t&&(t.currentScript&&"SCRIPT"===t.currentScript.tagName.toUpperCase()&&(e=t.currentScript.src),!e)){var r=t.getElementsByTagName("script");if(r.length)for(var o=r.length-1;o>-1&&(!e||!/^http(s?):/.test(e));)e=r[o--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),n.p=e})(),n.b=document.baseURI||self.location.href;const o=new Array(128).fill(void 0);function i(e){return o[e]}o.push(void 0,null,!0,!1);let s=o.length;function a(e){s===o.length&&o.push(o.length+1);const t=s;return s=o[t],o[t]=e,t}function c(e,t){try{return e.apply(this,t)}catch(e){r.__wbindgen_exn_store(a(e))}}function l(e){const t=i(e);return function(e){e<132||(o[e]=s,s=e)}(e),t}function u(e){return null==e}let b=null;function d(){return(null===b||!0===b.buffer.detached||void 0===b.buffer.detached&&b.buffer!==r.memory.buffer)&&(b=new DataView(r.memory.buffer)),b}function g(e){const t=typeof e;if("number"==t||"boolean"==t||null==e)return`${e}`;if("string"==t)return`"${e}"`;if("symbol"==t){const t=e.description;return null==t?"Symbol":`Symbol(${t})`}if("function"==t){const t=e.name;return"string"==typeof t&&t.length>0?`Function(${t})`:"Function"}if(Array.isArray(e)){const t=e.length;let n="[";t>0&&(n+=g(e[0]));for(let r=1;r<t;r++)n+=", "+g(e[r]);return n+="]",n}const n=/\[object ([^\]]+)\]/.exec(toString.call(e));let r;if(!(n&&n.length>1))return toString.call(e);if(r=n[1],"Object"==r)try{return"Object("+JSON.stringify(e)+")"}catch(e){return"Object"}return e instanceof Error?`${e.name}: ${e.message}\n${e.stack}`:r}let _=0,h=null;function f(){return null!==h&&0!==h.byteLength||(h=new Uint8Array(r.memory.buffer)),h}const p="undefined"!=typeof TextEncoder?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},w="function"==typeof p.encodeInto?function(e,t){return p.encodeInto(e,t)}:function(e,t){const n=p.encode(e);return t.set(n),{read:e.length,written:n.length}};function m(e,t,n){if(void 0===n){const n=p.encode(e),r=t(n.length,1)>>>0;return f().subarray(r,r+n.length).set(n),_=n.length,r}let r=e.length,o=t(r,1)>>>0;const i=f();let s=0;for(;s<r;s++){const t=e.charCodeAt(s);if(t>127)break;i[o+s]=t}if(s!==r){0!==s&&(e=e.slice(s)),o=n(o,r,r=s+3*e.length,1)>>>0;const t=f().subarray(o+s,o+r);s+=w(e,t).written,o=n(o,r,s,1)>>>0}return _=s,o}const y="undefined"!=typeof TextDecoder?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};function v(e,t){return e>>>=0,y.decode(f().subarray(e,e+t))}"undefined"!=typeof TextDecoder&&y.decode();const $="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>r.__wbg_game_free(e>>>0,1)));class j{__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,$.unregister(this),e}free(){const e=this.__destroy_into_raw();r.__wbg_game_free(e,0)}constructor(){const e=r.game_new();return this.__wbg_ptr=e>>>0,$.register(this,this.__wbg_ptr,this),this}get board(){return l(r.game_board(this.__wbg_ptr))}get player_position(){return l(r.game_player_position(this.__wbg_ptr))}get level(){return l(r.game_level(this.__wbg_ptr))}get is_complete(){return l(r.game_is_complete(this.__wbg_ptr))}get move_count(){return l(r.game_move_count(this.__wbg_ptr))}get objects_positions(){return l(r.game_objects_positions(this.__wbg_ptr))}update_player_position(e){return 0!==r.game_update_player_position(this.__wbg_ptr,a(e))}update_level(e){return 0!==r.game_update_level(this.__wbg_ptr,a(e))}}function x(){const e={wbg:{}};return e.wbg.__wbg_buffer_609cc3eee51ed158=function(e){return a(i(e).buffer)},e.wbg.__wbg_call_672a4d21634d4a24=function(){return c((function(e,t){return a(i(e).call(i(t)))}),arguments)},e.wbg.__wbg_done_769e5ede4b31c67b=function(e){return i(e).done},e.wbg.__wbg_get_67b2ba62fc30de12=function(){return c((function(e,t){return a(Reflect.get(i(e),i(t)))}),arguments)},e.wbg.__wbg_get_b9b93047fe3cf45b=function(e,t){return a(i(e)[t>>>0])},e.wbg.__wbg_instanceof_ArrayBuffer_e14585432e3737fc=function(e){let t;try{t=i(e)instanceof ArrayBuffer}catch(e){t=!1}return t},e.wbg.__wbg_instanceof_Uint8Array_17156bcf118086a9=function(e){let t;try{t=i(e)instanceof Uint8Array}catch(e){t=!1}return t},e.wbg.__wbg_isArray_a1eab7e0d067391b=function(e){return Array.isArray(i(e))},e.wbg.__wbg_isSafeInteger_343e2beeeece1bb0=function(e){return Number.isSafeInteger(i(e))},e.wbg.__wbg_iterator_9a24c88df860dc65=function(){return a(Symbol.iterator)},e.wbg.__wbg_length_a446193dc22c12f8=function(e){return i(e).length},e.wbg.__wbg_length_e2d2a49132c1b256=function(e){return i(e).length},e.wbg.__wbg_new_78feb108b6472713=function(){return a(new Array)},e.wbg.__wbg_new_a12002a7f91c75be=function(e){return a(new Uint8Array(i(e)))},e.wbg.__wbg_next_25feadfc0913fea9=function(e){return a(i(e).next)},e.wbg.__wbg_next_6574e1a8a62d1055=function(){return c((function(e){return a(i(e).next())}),arguments)},e.wbg.__wbg_set_37837023f3d740e8=function(e,t,n){i(e)[t>>>0]=l(n)},e.wbg.__wbg_set_65595bdd868b3009=function(e,t,n){i(e).set(i(t),n>>>0)},e.wbg.__wbg_value_cd1ffa7b1ab794f1=function(e){return a(i(e).value)},e.wbg.__wbindgen_bigint_from_i64=function(e){return a(e)},e.wbg.__wbindgen_bigint_from_u64=function(e){return a(BigInt.asUintN(64,e))},e.wbg.__wbindgen_bigint_get_as_i64=function(e,t){const n=i(t),r="bigint"==typeof n?n:void 0;d().setBigInt64(e+8,u(r)?BigInt(0):r,!0),d().setInt32(e+0,!u(r),!0)},e.wbg.__wbindgen_boolean_get=function(e){const t=i(e);return"boolean"==typeof t?t?1:0:2},e.wbg.__wbindgen_debug_string=function(e,t){const n=m(g(i(t)),r.__wbindgen_malloc,r.__wbindgen_realloc),o=_;d().setInt32(e+4,o,!0),d().setInt32(e+0,n,!0)},e.wbg.__wbindgen_error_new=function(e,t){return a(new Error(v(e,t)))},e.wbg.__wbindgen_is_bigint=function(e){return"bigint"==typeof i(e)},e.wbg.__wbindgen_is_function=function(e){return"function"==typeof i(e)},e.wbg.__wbindgen_is_object=function(e){const t=i(e);return"object"==typeof t&&null!==t},e.wbg.__wbindgen_jsval_eq=function(e,t){return i(e)===i(t)},e.wbg.__wbindgen_jsval_loose_eq=function(e,t){return i(e)==i(t)},e.wbg.__wbindgen_memory=function(){return a(r.memory)},e.wbg.__wbindgen_number_get=function(e,t){const n=i(t),r="number"==typeof n?n:void 0;d().setFloat64(e+8,u(r)?0:r,!0),d().setInt32(e+0,!u(r),!0)},e.wbg.__wbindgen_number_new=function(e){return a(e)},e.wbg.__wbindgen_object_drop_ref=function(e){l(e)},e.wbg.__wbindgen_string_get=function(e,t){const n=i(t),o="string"==typeof n?n:void 0;var s=u(o)?0:m(o,r.__wbindgen_malloc,r.__wbindgen_realloc),a=_;d().setInt32(e+4,a,!0),d().setInt32(e+0,s,!0)},e.wbg.__wbindgen_throw=function(e,t){throw new Error(v(e,t))},e}async function k(e){if(void 0!==r)return r;void 0!==e&&(Object.getPrototypeOf(e)===Object.prototype?({module_or_path:e}=e):console.warn("using deprecated parameters for the initialization function; pass a single object instead")),void 0===e&&(e=new URL(n(104),n.b));const t=x();("string"==typeof e||"function"==typeof Request&&e instanceof Request||"function"==typeof URL&&e instanceof URL)&&(e=fetch(e));const{instance:o,module:i}=await async function(e,t){if("function"==typeof Response&&e instanceof Response){if("function"==typeof WebAssembly.instantiateStreaming)try{return await WebAssembly.instantiateStreaming(e,t)}catch(t){if("application/wasm"==e.headers.get("Content-Type"))throw t;console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",t)}const n=await e.arrayBuffer();return await WebAssembly.instantiate(n,t)}{const n=await WebAssembly.instantiate(e,t);return n instanceof WebAssembly.Instance?{instance:n,module:e}:n}}(await e,t);return function(e,t){return r=e.exports,k.__wbindgen_wasm_module=t,b=null,h=null,r}(o,i)}const O=k;class A{constructor(e,t){this.$debug=null,this.$container=document.querySelector(`#${e}`),this.title=t}render(){this.$container.innerHTML=`\n  <h1>${this.title}</h1>\n\n  <canvas id="scene"></canvas>\n\n  <div>\n    <label>Select a level:</label>\n    <br />\n    <select id="level">\n      ${[...Array(2).keys()].reduce(((e,t)=>e+`<option value=${t}>level ${t+1}</option>`),"")}\n    </select>\n  </div>\n\n  <p>\n    <pre id="debug"></pre>\n  </p>\n\n  <style>\n    #scene {\n      margin-bottom: 1rem;\n    }\n  </style>\n    `,this.$debug=this.$container.querySelector("#debug")}debug(e){this.$debug&&(this.$debug.innerText=e)}}const S=class{constructor(e){this.loopId=0,this.startTimestamp=0,this.timestamp=0,this.framesCount=0,this.renderer=e}start(e){this.startTimestamp=Number((Date.now()/1e3).toFixed()),this.timestamp=this.startTimestamp,requestAnimationFrame((()=>this.loop(e)))}stop(){cancelAnimationFrame(this.loopId),this.timestamp=0,this.loopId=0}loop(e){if(0<this.loopId){e(),this.renderer.render(),this.framesCount++;let t=Number((Date.now()/1e3).toFixed());this.timestamp<t&&(console.log(`time: ${this.timestamp-this.startTimestamp}\nframesCount: ${this.framesCount}`),this.timestamp=t,this.framesCount=0)}this.loopId=requestAnimationFrame((()=>this.loop(e)))}};var T;!function(e){e[e.Lines=0]="Lines",e[e.Filled=1]="Filled"}(T||(T={}));const C=class{constructor(e,t){this.objects={},this.staticObjects={},this.background=null,this.$canvas=e,this.context=this.$canvas.getContext("2d"),this.$shadow=document.createElement("canvas"),this.shadowContext=this.$shadow.getContext("2d",{willReadFrequently:!0}),this.options=t,this.setCanvas(),this.setBackground(),this.clear()}render(){this.clear(),this.renderBackground(this.context),this.renderObjects(this.context,this.objects)}add(e){return e.id in this.objects?(console.error(`object ${e.id} already added`),!1):(this.objects[e.id]=e,!0)}remove(e){return e in this.objects?(delete this.objects[e],!0):(console.error(`object ${e} not added`),!1)}addStatic(e){return e.id in this.staticObjects?(console.error(`object ${e.id} already added`),!1):(this.staticObjects[e.id]=e,this.setBackground(),!0)}removeStatic(e){return e in this.staticObjects?(delete this.staticObjects[e],!0):(console.error(`object ${e} not added`),!1)}reset(){this.objects={},this.staticObjects={},this.background=null,this.context.reset(),this.clear()}setBackground(){const{width:e,height:t}=this.options;this.shadowContext.reset(),this.shadowContext.clearRect(0,0,e,t),this.renderScene(this.shadowContext),this.renderObjects(this.shadowContext,this.staticObjects),this.background=this.shadowContext.getImageData(0,0,e,t)}setCanvas(){const{width:e,height:t,backgroundColor:n}=this.options;[this.$canvas,this.$shadow].map((r=>{r.width=e,r.height=t,r.style.backgroundColor=this.rgba(n)}))}clear(){const{width:e,height:t}=this.options;this.context.clearRect(0,0,e,t)}rgba(e){return`rgba(${e.join(", ")})`}renderScene(e){const{width:t,height:n,resolution:r}=this.options,o=[t/r[0],n/r[1]];e.strokeStyle=this.rgba([0,0,0,1]),e.lineWidth=.1,e.beginPath(),[...Array(o[1]-1).keys()].map((i=>{e.moveTo(0,(i+1)*r[1]),e.lineTo(t,(i+1)*r[1]),[...Array(o[0]-1).keys()].map((t=>{e.moveTo((t+1)*r[0],0),e.lineTo((t+1)*r[0],n)}))})),e.stroke()}renderBackground(e){this.background&&e.putImageData(this.background,0,0)}renderObjects(e,t){const{resolution:n}=this.options;Object.keys(t).map((r=>{const o=t[r],{position:i,data:s,color:a,scale:c,type:l,rotation:u}=o,b=T.Lines===l;let d=[0,0];if(e[b?"strokeStyle":"fillStyle"]=this.rgba(a),e.beginPath(),this.rotate(s,u).map(((t,r)=>{const o=[i[0]*n[0]+t[0]*c[0]*n[0],i[1]*n[1]+t[1]*c[1]*n[1]];e[0===r?"moveTo":"lineTo"](o[0],o[1]),d[0]<o[0]&&(d[0]=o[0]),d[1]<o[1]&&(d[1]=o[1])})),e[b?"stroke":"fill"](),o.texture){let t=[i[0]*n[0],i[1]*n[1]];e.drawImage(o.texture,t[0],t[1],d[0]-t[0],d[1]-t[1])}}))}rotate(e,t){return e}},I=class{constructor(e){this.eventObjects=[],this.$eventListener=document.createElement("div"),this.eventObjects=e,this.eventObjects.map((e=>{const{name:t,eventType:n,$target:r,dataCallback:o}=e;r.addEventListener(n,(e=>{this.$eventListener.dispatchEvent(new CustomEvent(t,{detail:o(r,e)}))}))}))}addEventListener(e,t){this.$eventListener.addEventListener(e,(e=>t(e.detail)))}};var L=function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))};window.addEventListener("load",(()=>{O().then((()=>L(void 0,void 0,void 0,(function*(){const e=new A("app","Sokoban");e.render();const t=new j,n=(yield function(e){return L(this,void 0,void 0,(function*(){return yield Promise.all(e.map((e=>new Promise((t=>{const n=()=>t(e);if(e.$image)return n();e.$image=new Image,e.$image.src=e.source,e.$image.addEventListener("load",(()=>(console.log(`${e.source} loaded`),n())))})))))}))}([{id:"player",source:"./assets/player.png"},{id:"block",source:"./assets/block.png"},{id:"box",source:"./assets/box.png"}])).reduce(((e,t)=>(e[t.id]=t,e)),{}),r={player:[100,100,255,1],block:[125,125,125,1],target:[0,0,0,1],box:[200,150,0,1],boxLine:[0,0,0,1]},o=(()=>{const e=t.board.length;return{width:500,height:500,backgroundColor:[255,255,255,1],resolution:[500/t.board[0].length,500/e]}})(),i=[{name:"test-click",eventType:"click",$target:e.$container.querySelector("#scene"),dataCallback:(e,t)=>{const n=e.getBoundingClientRect();return{position:[t.clientX-n.left,t.clientY-n.top]}}},{name:"go-to",eventType:"keyup",$target:document,dataCallback:(e,t)=>{let n=null;switch(t.key){case"ArrowUp":n="up";break;case"ArrowDown":n="down";break;case"ArrowLeft":n="left";break;case"ArrowRight":n="right"}return{direction:n}}},{name:"level-selected",eventType:"change",$target:e.$container.querySelector("#level"),dataCallback:(e,t)=>({level:""===e.value||isNaN(Number(e.value))?null:Number(e.value)})}],s=new C(e.$container.querySelector("#scene"),o),a=new I(i),c=new S(s),l=()=>{const e=function(e,t,n,r,o,i){console.log(i);const s={data:[[0,0,0],[0,1,0],[1,1,0],[1,0,0]],scale:[1,1],rotation:[0,0,0],type:T.Filled},a=Object.assign(Object.assign({},s),{id:"player",position:e,color:o.player,texture:i.player.$image}),c=t.map(((e,t)=>Object.assign(Object.assign({},s),{position:e,id:`block-${t}`,color:o.block,texture:i.block.$image}))),l=n.map(((e,t)=>Object.assign(Object.assign({},s),{id:`target-${t}`,position:e,color:o.target}))),u=r.map(((e,t)=>Object.assign({id:`box-${t}`,position:e,color:o.box,texture:i.box.$image},s))),b=u.map(((e,t)=>Object.assign(Object.assign({},e),{id:`box-line-${t}`,data:(()=>{const e=[[0,0,0],[0,1,0],[1,1,0],[1,0,0]];return[...e,e[0],e[2],e[1],e[3]]})(),color:o.boxLine,type:T.Lines})));return{player:a,blocks:c,targets:l,boxes:u,boxLines:b}}(t.player_position,t.objects_positions[0],t.objects_positions[1],t.objects_positions[2],r,n),{player:o,blocks:i,targets:a,boxes:c,boxLines:l}=e;return[...i,...a].map((e=>s.addStatic(e))),[o,...c,...l].map((e=>s.add(e))),e};let u=l();a.addEventListener(i[0].name,(e=>{e.position&&console.log("click:",e.position)})),a.addEventListener(i[1].name,(e=>{if(!e.direction)return;let n=[0,0];switch(e.direction){case"up":n[1]=-1;break;case"down":n[1]=1;break;case"left":n[0]=-1;break;case"right":n[0]=1}0===n[0]&&0===n[1]||(t.update_player_position(n)?(u.player.position=t.player_position,[...Array(t.objects_positions[2].length).keys()].map((e=>{u.boxes[e].position=t.objects_positions[2][e],u.boxLines[e].position=t.objects_positions[2][e]})),t.is_complete&&setTimeout((()=>{alert("Finished!")}),100)):console.error(`unable to update player position with offset [${n.join(", ")}]`))})),a.addEventListener(i[2].name,(e=>{null!=e.level&&t.update_level!==e.level&&(t.update_level(e.level)?(s.reset(),u=l(),s.setBackground(),i[2].$target.blur()):console.error(`update level from ${t.level} to ${e.level} `))})),c.start((()=>{e.debug(`level: ${t.level+1}\nmove count: ${t.move_count}\n\n`+t.board.reduce(((e,t)=>e+t.join(" ")+"\n"),""))}))}))))}))})();